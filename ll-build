#!/bin/sh

# ll-build - The Laptop Lab build script
#
# Copyright (C) 2012  Anthony Green <green@redhat.com>
# Distrubuted under the terms of the GPL v3 or later.

# ==== Configure this section ======================================

# Either modify the definition of these variables within this file, or
# set them in a file called ll-config, which this script will read.
if test -f ./ll-config; then
  source ./ll-config
fi

# The domain name for my private network.
LL_DOMAIN=${LL_DOMAIN-example.org}

# My timezone
LL_TIMEZONE=${LL_TIMEZONE-America/Toronto}

# Where is the RHEL DVD ISO?
LL_RHELDVD=${LL_RHELDVD-/path/to/rheldvd.iso}

# What root password do you plan on using?
LL_ROOTPW=${LL_ROOTPW-passw0rd}

# Where's a safe place for temporary mounts on this host?
LL_MOUNTPOINT=${LL_MOUNTPOINT-/mnt}

# Your RHN login name
LL_RHNLOGIN=${LL_RHNLOGIN-mylogin}

# Activation key for SAM server.  Point your browser here:
# https://rhn.redhat.com/network/account/activation_keys/list.pxt and
# create a new Activation Key with the Red Hat Default base channel,
# and the "SAM for RHEL Server (v.6 64-bit x86_64)" child channel.
LL_SAM_KEY=${LL_SAM_KEY-myactivationkey}

# Path to the manifest file for the subscription asset manage,
# currently assumed to be called manifest.zip.  The SAM kickstart file
# should be modified if this is not the case.  FIXME.
LL_SAM_MANIFEST=${LL_SAM_MANIFEST-manifest.zip}

# More SAM configury...
LL_SAM_ADMIN=${LL_SAM_ADMIN-admin}
LL_SAM_ADMINPWD=${LL_SAM_ADMINPWD-$LL_ROOTPW}
LL_SAM_ORGNAME=${LL_SAM_ORGNAME-Laptop_Lab}

# === Basic Sanity Checks ==============================================

# TODO - verify that I am root
# TODO - verify $LL_RHELDVD
# TODO - verify $LL_MOUNTPOINT 

# === Utility Functions ================================================

# Generate random MAC addresses that start with 52:00:

function generate_MAC_address() {
  SOURCE=`dd if=/dev/urandom count=1 2>/dev/null | openssl dgst -md5`
  eval "$1='52:00:$(echo ${SOURCE} | sed 's/^............\(..\)\(..\)\(..\)\(..\).*$/\1:\2:\3:\4/')'"
}

# === Subscription Asset Manager =======================================
#
# Let's set up the SAM server first.  This is the server through which
# other servers will register to RHN and acts as a gateway to the RHN
# content delivery network.  We need this, for instance, to get
# cobbler from the satellite server channel.
#

# First, mount the RHEL DVD under /mnt, or similar.
mount -o loop -t iso9660 $LL_RHELDVD $LL_MOUNTPOINT

# Generate a couple of MAC addresses for eth0 and eth1.
generate_MAC_address ETH0_MAC
generate_MAC_address ETH1_MAC

cat > sam.ks <<EOF
install
text
reboot
lang en_US.UTF-8
keyboard us
network --bootproto static --ip=10.0.0.97 \
 --netmask=255.255.255.0 --nameserver=10.0.0.99 \
 --hostname sam.$LL_DOMAIN \
 --nodefroute \
 --noipv6 \
 --device=$ETH0_MAC
network --bootproto dhcp \
 --hostname sam.$LL_DOMAIN \
 --noipv6 \
 --device=$ETH1_MAC
rootpw $LL_ROOTPW
firewall --enabled --ssh --port=80:tcp,443:tcp,8088:tcp
selinux --enforcing
timezone --utc $LL_TIMEZONE
bootloader --location=mbr --append="rd_NO_PLYMOUTH"
zerombr
clearpart --all --initlabel
autopart
%packages
@core
# Install packages required by SAM.  Doing this here pulls them from
# the DVD ISO rather than over the net from RHN.
antlr
apr-util
cvs
ecj
gdb
gettext
gstreamer
gstreamer-plugins-base
ghostscript
ghostscript-fonts
httpd
httpd-tools
iso-codes
jakarta-commons-collections
jakarta-commons-daemon
jakarta-commons-dbcp
jakarta-commons-discovery
jakarta-commons-httpclient
jakarta-commons-logging
jakarta-commons-pool
java-1.5.0-gcj
java-1.6.0-openjdk
jline
jna
jpackage-utils
libXfont
libXtst
libXv
libXxf86vm
libcgroup
libfontenc
libgomp
libmng
libogg
liboil
libselinux-python
libselinux-ruby
libsndfile
libtheora
libvorbis
mailcap
make
mesa-dri-drivers
mesa-libGL
mesa-libGLU
mod_ssl
mx4j
openjpeg-libs
patch
perl-CGI
perl-ExtUtils-MakeMaker
perl-ExtUtils-ParseXS
perl-Test-Harness
postgresql
postgresql-jdbc
postgresql-libs
postgresql-server
pulseaudio-libs
qt
qt-sqlite
qt4
redhat-lsb
setools-libs
setools-libs-python
sinjdoc
tomcat6
tomcat6-el-2.1-api
tomcat6-jsp-2.1-api
tomcat6-lib
tomcat6-servlet-2.5-api
tzdata-java
urw-fonts
xml-common
xml-commons-apis
xml-commons-resolver
xorg-x11-font-utils
%post --log=/root/post_install_1.log
# Even though we are using DHCP, /etc/resolv.conf is not configured at
# this point in the installation process.  Let's use google's public
# DNS servers.
echo "nameserver 8.8.8.8" > /etc/resolv.conf
echo "nameserver 8.8.4.4" >> /etc/resolv.conf

# Now we register the SAM server to hosted RHN classic...
rhnreg_ks --profilename=$LL_RHNLOGIN --activationkey=$LL_SAM_KEY

# Install and configure katello...
yum install -y katello-headpin-all

# Set up a post-reboot script
/bin/cat > /root/post-boot-configure.sh <<PBCEND
#!/bin/sh
katello-configure --deployment=sam \
  --user-name=$LL_SAM_ADMIN \
  --user-pass=$LL_SAM_ADMINPWD \
  --org-name=$LL_SAM_ORGNAME
headpin -u $LL_SAM_ADMIN -p $LL_SAM_ADMINPWD provider import_manifest --org $LL_SAM_ORGNAME --name "Red Hat" --file /root/manifest.zip
headpin -u $LL_SAM_ADMIN -p $LL_SAM_ADMINPWD environment create --org $LL_SAM_ORGNAME --name Lab --prior Library
PBCEND
chmod +x /root/post-boot-configure.sh
cp /etc/rc.d/rc.local /etc/rc.d/rc.local.backup
cat >> /etc/rc.d/rc.local <<PBCRCEND
. /etc/init.d/functions
action "Running Post Boot Configure script: " /bin/true
/root/post-boot-configure.sh > /root/post-boot-configure.log 2>&1
action "  Restoring original rc.local: " mv -f /etc/rc.d/rc.local.backup /etc/rc.d/rc.local
PBCRCEND
%end

%post --nochroot --log=/mnt/sysimage/root/post_install_2.log
# Copy the SAM manifest file from our initrd image into /root
cp /manifest.zip /mnt/sysimage/root
%end
EOF

virt-install \
    --disk $LL_RHELDVD,device=cdrom \
    --name sam.$LL_DOMAIN --ram 1024 \
    --disk /var/lib/libvirt/images/sam.$LL_DOMAIN.img,size=8 \
    --network network:10_0,model=virtio,mac=$ETH0_MAC \
    --network network:default,model=virtio,mac=$ETH1_MAC \
    -l $LL_MOUNTPOINT \
    -x "ks=file:/sam.ks" \
    --initrd-inject=sam.ks \
    --initrd-inject=$LL_SAM_MANIFEST --noreboot --force

# Restart the guest to complete katello's configuration (see the
# kickstart file's %post section for details).  This just starts the
# guest, and we'll move on while it continues to run.
virsh --connect qemu:///system start sam.$LL_DOMAIN

# === IPA ==============================================================

# Generate a couple of MAC addresses for eth0 and eth1.
generate_MAC_address ETH0_MAC
generate_MAC_address ETH1_MAC

cat > ipa.ks <<EOF
install
text
reboot
lang en_US.UTF-8
keyboard us
network --bootproto static --ip=10.0.0.99 \
 --netmask=255.255.255.0 --nameserver=10.0.0.99 \
 --hostname ipa.$LL_DOMAIN \
 --nodefroute \
 --noipv6 \
 --device=$ETH0_MAC
network --bootproto dhcp \
 --hostname ipa.$LL_DOMAIN \
 --noipv6 \
 --device=$ETH1_MAC
rootpw $LL_ROOTPW
# IPA needs a number of ports open.  See the documentation for details.
firewall --enabled --ssh --port=80:tcp,443:tcp,389:tcp,636:tcp,88:tcp,88:udp,464:tcp,464:udp,53:tcp,53:udp,7389:tcp
selinux --enforcing
timezone --utc $LL_TIMEZONE
bootloader --location=mbr --append="rd_NO_PLYMOUTH"
zerombr
clearpart --all --initlabel
autopart
%packages
@core
subscription-manager
@identity-management-server
bind
bind-dyndb-ldap
%post --log=/root/post_install_1.log
echo "10.0.0.97  sam.$LL_DOMAIN sam" >> /etc/hosts
rpm -ivh http://sam.$LL_DOMAIN/pub/candlepin-cert-consumer-sam.$LL_DOMAIN-1.0-1.noarch.rpm
subscription-manager register --user $LL_SAM_ADMIN --password $LL_SAM_ADMINPWD --org $LL_SAM_ORGNAME --env Lab
%end
EOF

virt-install \
    --disk $LL_RHELDVD,device=cdrom \
    --name ipa.$LL_DOMAIN --ram 1024 \
    --disk /var/lib/libvirt/images/ipa.$LL_DOMAIN.img,size=8 \
    --network network:10_0,model=virtio,mac=$ETH0_MAC \
    --network network:default,model=virtio,mac=$ETH1_MAC \
    -l $LL_MOUNTPOINT \
    -x "ks=file:/ipa.ks" \
    --initrd-inject=ipa.ks \
    --noreboot --force

# Restart the guest and move on.
virsh --connect qemu:///system start ipa.$LL_DOMAIN

exit

# The rest is not complete.

# === Cobbler ==========================================================

cat > cobbler.ks <<EOF
# Minimal Kickstart file
install
text
reboot
lang en_US.UTF-8
keyboard us
network --bootproto dhcp --hostname cobbler.$LL_DOMAIN
#Choose a saner password here.
rootpw $LL_ROOTPW
firewall --enabled --ssh
selinux --enforcing
timezone --utc $LL_TIMEZONE
bootloader --location=mbr --append="console=tty0 console=ttyS0,115200 rd_NO_PLYMOUTH"
zerombr
clearpart --all --initlabel
autopart
#Just core packages
%packages
@core
emacs
%end
EOF

virt-install \
    --disk $LL_RHELDVD,device=cdrom \
    --name cobbler.$LL_DOMAIN --ram 2048 --disk cobbler.$LL_DOMAIN,size=8 \
    --nographics -l $LL_MOUNTPOINT \
    -x "ks=file:/cobbler.ks" \
    --initrd-inject=cobbler.ks --noreboot --force


